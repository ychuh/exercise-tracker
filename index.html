<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>運動挑戰追蹤器（分輪次 / Username-Password）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family:'Inter',sans-serif;background:#f3f4f6;color:#1f2937}
    .daily-log-table-container{overflow-x:auto}
    .daily-log-table th,.daily-log-table td{min-width:80px;text-align:center}
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;
           background:rgba(0,0,0,.4);justify-content:center;align-items:center}
    .modal-content{background:#fff;margin:auto;padding:20px;border-radius:12px;width:90%;max-width:420px;
                   box-shadow:0 4px 6px rgba(0,0,0,.1)}
  </style>
</head>
<body class="p-6 md:p-12 min-h-screen flex items-center justify-center">

  <!-- 登入區 -->
  <div id="login-page" class="w-full max-w-md p-8 bg-white rounded-2xl shadow-xl">
    <h1 class="text-2xl font-bold mb-6 text-blue-800 text-center">運動挑戰追蹤器</h1>
    <div class="text-sm text-gray-600 mb-4 text-center">
      <div>目前輪次：<span id="login-round-label" class="font-semibold"></span></div>
      <div>日期範圍：<span id="login-range-label"></span></div>
    </div>
    <div class="space-y-3">
      <input id="username" placeholder="使用者名稱（英數._-，也會作為你的初始參賽者名稱）"
             class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
      <input id="password" type="password" placeholder="密碼"
             class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
      <button id="loginBtn" class="w-full py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
        登入（無帳號會自動建立）
      </button>
      <p id="login-error" class="text-sm text-red-600 h-5"></p>
    </div>
    <p class="text-xs text-gray-500 mt-4">此登入為前端自管帳密，不使用 Firebase Authentication。</p>
  </div>

  <!-- 主頁 -->
  <div id="app-page" class="hidden bg-white p-8 rounded-2xl shadow-xl max-w-6xl w-full">
    <div class="flex flex-col md:flex-row justify-between items-center mb-4">
      <div>
        <h1 class="text-3xl font-bold text-blue-800">
          30天運動挑戰
        </h1>
        <div class="text-sm text-gray-600">
          目前輪次：<span id="round-label" class="font-semibold"></span>，
          日期：<span id="range-label"></span>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <div class="text-right leading-tight">
          <div id="user-name" class="text-sm font-semibold"></div>
          <div class="text-xs text-gray-500">ID：<span id="user-id"></span></div>
        </div>
        <button id="logoutBtn" class="ml-2 px-3 py-1.5 text-sm bg-gray-200 hover:bg-gray-300 rounded-md">登出</button>
      </div>
    </div>

    <p class="text-gray-600 text-center mb-6">目標：30天內完成總計 2500 下運動</p>

    <!-- 日期 -->
    <div class="flex items-center justify-center gap-4 mb-8">
      <div class="flex items-center gap-2">
        <label for="date-select" class="text-lg font-medium text-gray-700">選擇日期:</label>
        <input type="date" id="date-select" class="p-2 rounded-lg border border-gray-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
    </div>

    <!-- 操作三鍵 -->
    <div class="flex flex-wrap items-center justify-center gap-4 mb-8">
      <button id="btn-squat"  class="bg-blue-600  hover:bg-blue-700  text-white font-semibold py-2 px-4 rounded-lg shadow-md transition hover:scale-105">深蹲</button>
      <button id="btn-pushup" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition hover:scale-105">伏地挺身</button>
      <button id="btn-rowing"  class="bg-red-600   hover:bg-red-700   text-white font-semibold py-2 px-4 rounded-lg shadow-md transition hover:scale-105">划船</button>
    </div>

    <!-- 總進度（所有人；只有自己那列可 [編輯] 名稱） -->
    <div class="overflow-x-auto mb-8">
      <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
        <thead>
          <tr class="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal">
            <th class="py-3 px-6 text-left">參賽者</th>
            <th class="py-3 px-6 text-left">深蹲總計</th>
            <th class="py-3 px-6 text-left">伏地挺身總計</th>
            <th class="py-3 px-6 text-left">划船總計</th>
            <th class="py-3 px-6 text-left">總計</th>
            <th class="py-3 px-6 text-left">完成度</th>
          </tr>
        </thead>
        <tbody id="progress-table-body" class="text-gray-600 text-sm font-light"></tbody>
      </table>
    </div>

    <!-- 每日紀錄 -->
    <h2 class="text-2xl font-bold mb-4 text-gray-800 text-center">每日運動紀錄</h2>
    <div class="daily-log-table-container">
      <table id="daily-log-table" class="bg-white border border-gray-200 rounded-lg shadow-sm w-full">
        <thead id="daily-log-table-head" class="bg-gray-100 text-gray-600 uppercase text-xs leading-normal"></thead>
        <tbody id="daily-log-table-body" class="text-gray-600 text-sm font-light"></tbody>
      </table>
    </div>
  </div>

  <!-- 數量 Modal -->
  <div id="reps-modal" class="modal">
    <div class="modal-content">
      <h3 id="reps-modal-title" class="text-xl font-bold mb-4">輸入數量</h3>
      <p id="reps-modal-text" class="mb-4 text-gray-700"></p>
      <input type="number" id="reps-input" class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4" placeholder="請輸入數量">
      <div class="flex justify-end gap-2">
        <button id="reps-modal-cancel"  class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">取消</button>
        <button id="reps-modal-confirm" class="bg-blue-600 hover:bg-blue-700  text-white font-semibold py-2 px-4 rounded-lg">確認</button>
      </div>
    </div>
  </div>

  <!-- 編輯自己名稱 Modal -->
  <div id="name-modal" class="modal">
    <div class="modal-content">
      <h3 class="text-xl font-bold mb-4">編輯你的顯示名稱</h3>
      <input type="text" id="name-input" class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4" placeholder="請輸入新名稱">
      <div class="flex justify-end gap-2">
        <button id="name-modal-cancel"  class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">取消</button>
        <button id="name-modal-confirm" class="bg-blue-600 hover:bg-blue-700  text-white font-semibold py-2 px-4 rounded-lg">確認</button>
      </div>
    </div>
  </div>

  <!-- Firebase JS（只用 Firestore） -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc,
      collection, query, onSnapshot
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    /* ======== <<< 換下一輪只需要改這裡 >>> ======== */
    // 第二輪（示例）：2025-09-16 ~ 2025-10-15
    // 你要別的日期就把下面兩行改掉；ROUND_ID 建議跟著改成 "YYYY-MM-DD_YYYY-MM-DD"
    const CHALLENGE_START = '2025-08-16';
    const CHALLENGE_END   = '2025-09-15';
    const ROUND_ID        = `第二輪`;
    /* ================================================ */

	// Your web app's Firebase configuration
	const firebaseConfig = {
	  apiKey: "AIzaSyBpgbhTJkxi5j8HrwpUzFfZHAABcOfZnKs",
	  authDomain: "exercise-tracker-d339a.firebaseapp.com",
	  projectId: "exercise-tracker-d339a",
	  storageBucket: "exercise-tracker-d339a.firebasestorage.app",
	  messagingSenderId: "133943402653",
	  appId: "1:133943402653:web:03328186b7addd755b3474",
	  measurementId: "G-VSP6K6KQHG"
	};

    // ===== 初始化 =====
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ===== 全域狀態 =====
    let currentUser = null;           // username
    let unsubscribe = null;           // participants 監聽
    const TOTAL_GOAL = 2500;

    // ===== DOM =====
    const loginPage = document.getElementById('login-page');
    const appPage   = document.getElementById('app-page');

    const loginBtn  = document.getElementById('loginBtn');
    const loginErr  = document.getElementById('login-error');
    const usernameI = document.getElementById('username');
    const passwordI = document.getElementById('password');

    const loginRoundLabel = document.getElementById('login-round-label');
    const loginRangeLabel = document.getElementById('login-range-label');
    const roundLabel = document.getElementById('round-label');
    const rangeLabel = document.getElementById('range-label');

    const userName  = document.getElementById('user-name');
    const userIdEl  = document.getElementById('user-id');
    const logoutBtn = document.getElementById('logoutBtn');

    const dateSelect        = document.getElementById('date-select');
    const progressTableBody = document.getElementById('progress-table-body');
    const dailyLogTableHead = document.getElementById('daily-log-table-head');
    const dailyLogTableBody = document.getElementById('daily-log-table-body');

    const repsModal = document.getElementById('reps-modal');
    const repsModalTitle = document.getElementById('reps-modal-title');
    const repsModalText  = document.getElementById('reps-modal-text');
    const repsInput = document.getElementById('reps-input');
    const repsModalConfirm = document.getElementById('reps-modal-confirm');
    const repsModalCancel  = document.getElementById('reps-modal-cancel');

    const nameModal = document.getElementById('name-modal');
    const nameInput = document.getElementById('name-input');
    const nameModalConfirm = document.getElementById('name-modal-confirm');
    const nameModalCancel  = document.getElementById('name-modal-cancel');

    const btnSquat  = document.getElementById('btn-squat');
    const btnPushup = document.getElementById('btn-pushup');
    const btnRowing = document.getElementById('btn-rowing');

    // ===== 小工具 =====
    async function sha256(str){
      const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    function formatDate(date){
      const y=date.getFullYear();
      const m=String(date.getMonth()+1).padStart(2,'0');
      const d=String(date.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    function clampDateToRange(d){
      const min=new Date(CHALLENGE_START), max=new Date(CHALLENGE_END);
      if(d<min) return min; if(d>max) return max; return d;
    }
    function generateDateRange(){
      const res=[], end=new Date(CHALLENGE_END);
      let cur=new Date(CHALLENGE_START);
      while(cur<=end){ res.push(new Date(cur)); cur.setDate(cur.getDate()+1); }
      return res;
    }
    function initDate(){
      dateSelect.min = CHALLENGE_START;
      dateSelect.max = CHALLENGE_END;
      const today = clampDateToRange(new Date());
      dateSelect.value = formatDate(today);

      // 標題資訊
      loginRoundLabel.textContent = ROUND_ID;
      loginRangeLabel.textContent = `${CHALLENGE_START} ～ ${CHALLENGE_END}`;
      roundLabel.textContent = ROUND_ID;
      rangeLabel.textContent = `${CHALLENGE_START} ～ ${CHALLENGE_END}`;
    }

    // ===== 帳號登入（自管） =====
    async function loginWithUsernamePassword(username, password){
      loginErr.textContent='';
      const acctRef = doc(db, 'accounts', username);
      const snap = await getDoc(acctRef);
      const pwdHash = await sha256(password);

      if (!snap.exists()){
        // 註冊帳號
        await setDoc(acctRef, { passwordHash: pwdHash, createdAt: new Date().toISOString() });
      } else {
        if (snap.data().passwordHash !== pwdHash){
          throw new Error('密碼錯誤');
        }
      }

      // 確保本輪的 participant 存在
      const pRef = doc(db, `rounds/${ROUND_ID}/participants`, username);
      const pSnap = await getDoc(pRef);
      if (!pSnap.exists()){
        await setDoc(pRef, {
          name: username,
          creatorId: username,
          squat: 0, pushup: 0, rowing: 0, total: 0,
          dailyLog: JSON.stringify({}),
          updatedAt: new Date().toISOString(),
          roundId: ROUND_ID
        });
      }

      // 登入成功 → 記憶在 localStorage（含 round）
      localStorage.setItem('currentUser', username);
      localStorage.setItem('currentRoundId', ROUND_ID);
      currentUser = username;
    }

    function showApp(){
      loginPage.classList.add('hidden');
      appPage.classList.remove('hidden');
      userName.textContent = currentUser || '';
      userIdEl.textContent = currentUser || '';
      initDate();
      startParticipantsListener();
    }
    function showLogin(){
      appPage.classList.add('hidden');
      loginPage.classList.remove('hidden');
      if (unsubscribe){ unsubscribe(); unsubscribe = null; }
      initDate();
    }

    // ===== 監聽本輪 participants（排行榜 + 每日表）=====
    function startParticipantsListener(){
      if (unsubscribe) unsubscribe();
      const q = query(collection(db, `rounds/${ROUND_ID}/participants`));
      unsubscribe = onSnapshot(q, (snap)=>{
        const all={};
        snap.forEach(docSnap=>{
          const d = docSnap.data();
          if (d.dailyLog && typeof d.dailyLog === 'string'){
            try{ d.dailyLog = JSON.parse(d.dailyLog); }catch{ d.dailyLog = {}; }
          }
          all[docSnap.id] = d;
        });
        renderTables(all);
      }, (err)=>{
        console.error('監聽失敗：', err);
        alert(`Firestore 監聽失敗：${err.code || err.message}`);
      });
    }

    // ===== Render =====
    function renderTables(all){
      // Progress
      progressTableBody.innerHTML='';
      const ids = Object.keys(all).sort((a,b)=>{
        const ta=(all[a].total||0), tb=(all[b].total||0);
        if (tb!==ta) return tb-ta;
        return (all[a].name||a).localeCompare(all[b].name||b,'zh-Hant');
      });

      ids.forEach(id=>{
        const p = all[id];
        const completion = ((p.total/TOTAL_GOAL)*100).toFixed(1);
        const canEdit = (id === currentUser);
        const tr=document.createElement('tr');
        tr.className='border-b border-gray-200 hover:bg-gray-100';
        tr.innerHTML = `
          <td class="py-3 px-6 text-left whitespace-nowrap">
            ${p.name}
            ${canEdit ? `<button data-edit="${id}" class="text-blue-500 hover:text-blue-700 ml-2">[編輯]</button>` : ''}
          </td>
          <td class="py-3 px-6 text-left">${p.squat||0}</td>
          <td class="py-3 px-6 text-left">${p.pushup||0}</td>
          <td class="py-3 px-6 text-left">${p.rowing||0}</td>
          <td class="py-3 px-6 text-left font-bold text-lg">${p.total||0}</td>
          <td class="py-3 px-6 text-left">
            <div class="bg-gray-200 rounded-full h-2.5">
              <div class="bg-blue-500 h-2.5 rounded-full" style="width:${Math.min(completion,100)}%"></div>
            </div>
            <span class="text-xs text-gray-500">${completion}%</span>
          </td>`;
        progressTableBody.appendChild(tr);
      });

      // 綁定自己那列的「編輯」
      progressTableBody.querySelectorAll('button[data-edit]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          if (btn.dataset.edit !== currentUser) return;
          nameInput.value = all[currentUser]?.name || currentUser;
          nameModal.style.display='flex';
        });
      });

      // Daily
      dailyLogTableHead.innerHTML='';
      dailyLogTableBody.innerHTML='';
      const dates = generateDateRange();

      const headerRow=document.createElement('tr');
      headerRow.className='daily-log-table';
      const nameHeader=document.createElement('th');
      nameHeader.className='py-3 px-6 text-left';
      nameHeader.textContent='參賽者';
      headerRow.appendChild(nameHeader);
      dates.forEach(d=>{
        const th=document.createElement('th');
        th.className='py-3 px-2 text-center text-xs';
        th.textContent=`${d.getMonth()+1}/${d.getDate()}`;
        headerRow.appendChild(th);
      });
      dailyLogTableHead.appendChild(headerRow);

      ids.forEach(id=>{
        const p = all[id];
        const tr=document.createElement('tr');
        tr.className='border-b border-gray-200 hover:bg-gray-100';
        const nameCell=document.createElement('td');
        nameCell.className='py-3 px-6 text-left whitespace-nowrap';
        nameCell.textContent=p.name;
        tr.appendChild(nameCell);

        dates.forEach(d=>{
          const key=formatDate(d);
          const rec = (p.dailyLog||{})[key] || {squat:0,pushup:0,rowing:0};
          const sum = (rec.squat||0)+(rec.pushup||0)+(rec.rowing||0);
          const td=document.createElement('td');
          td.className='py-3 px-2 text-center text-xs';
          td.textContent = sum>0 ? sum : '-';
          tr.appendChild(td);
        });
        dailyLogTableBody.appendChild(tr);
      });

      // 更新三鍵顯示（僅自己）
      updateExerciseButtons(all[currentUser]);
    }

    function updateExerciseButtons(self){
      const date=dateSelect.value;
      if(!self || !date){
        btnSquat.textContent='深蹲';
        btnPushup.textContent='伏地挺身';
        btnRowing.textContent='划船';
        return;
      }
      const rec = (self.dailyLog||{})[date] || {squat:0,pushup:0,rowing:0};
      btnSquat.textContent = `深蹲 (${rec.squat||0})`;
      btnPushup.textContent = `伏地挺身 (${rec.pushup||0})`;
      btnRowing.textContent = `划船 (${rec.rowing||0})`;
    }

    // ===== 寫入自己紀錄（本輪）=====
    async function saveReps(kind, date, newVal){
      const ref = doc(db, `rounds/${ROUND_ID}/participants`, currentUser);
      const snap = await getDoc(ref);
      if (!snap.exists()) return;
      const data = snap.data();
      const daily = typeof data.dailyLog === 'string' ? JSON.parse(data.dailyLog) : (data.dailyLog||{});
      const old = ((daily[date]||{})[kind]) || 0;
      const diff = newVal - old;

      // 更新彙總
      const accum = {
        squat: data.squat||0,
        pushup: data.pushup||0,
        rowing: data.rowing||0,
        total:  data.total ||0
      };
      accum[kind] += diff;
      accum.total += diff;

      // 更新 daily
      if (!daily[date]) daily[date] = {squat:0,pushup:0,rowing:0};
      daily[date][kind] = newVal;

      await setDoc(ref, {
        ...accum,
        dailyLog: JSON.stringify(daily),
        updatedAt: new Date().toISOString()
      }, { merge:true });
    }

    async function saveOwnName(newName){
      await updateDoc(doc(db, `rounds/${ROUND_ID}/participants`, currentUser), {
        name: newName,
        updatedAt: new Date().toISOString()
      });
      userName.textContent = newName;
    }

    // ===== Modals =====
    function showRepsModal(type, initial){
      return new Promise((resolve)=>{
        repsModalTitle.textContent=`編輯${type}數量`;
        repsModalText.textContent=`請輸入你在 ${dateSelect.value} 完成的 ${type} 數量：`;
        repsInput.value = initial ?? '';
        repsModal.style.display='flex';
        repsInput.focus();

        const onConfirm=()=>{ repsModal.style.display='none';
          const v=parseInt(repsInput.value,10);
          resolve(Number.isFinite(v)&&v>=0 ? v : null); cleanup(); };
        const onCancel =()=>{ repsModal.style.display='none'; resolve(null); cleanup(); };
        function cleanup(){
          repsModalConfirm.removeEventListener('click',onConfirm);
          repsModalCancel .removeEventListener('click',onCancel);
        }
        repsModalConfirm.addEventListener('click',onConfirm);
        repsModalCancel .addEventListener('click',onCancel);
      });
    }

    // ===== 事件 =====
    loginBtn.addEventListener('click', async ()=>{
      const u = usernameI.value.trim();
      const p = passwordI.value;
      if (!u || !p){ loginErr.textContent='請輸入使用者名稱與密碼'; return; }
      if (!/^[A-Za-z0-9_.-]{3,32}$/.test(u)){ loginErr.textContent='使用者名稱僅限英數/._- (3-32字)'; return; }
      try{
        await loginWithUsernamePassword(u, p);
        showApp();
      }catch(e){
        loginErr.textContent = e.message || '登入失敗';
      }
    });

    logoutBtn.addEventListener('click', ()=>{
      localStorage.removeItem('currentUser');
      localStorage.removeItem('currentRoundId');
      currentUser = null;
      showLogin();
    });

    btnSquat .addEventListener('click', async ()=>{
      const cur = await (async ()=>{ const snap=await getDoc(doc(db,`rounds/${ROUND_ID}/participants`,currentUser));
        const d = snap.data(); const dl=typeof d.dailyLog==='string'?JSON.parse(d.dailyLog):d.dailyLog||{};
        return (dl[dateSelect.value]?.squat)||0; })();
      const v = await showRepsModal('深蹲', cur); if (v===null) return;
      await saveReps('squat', dateSelect.value, v);
    });
    btnPushup.addEventListener('click', async ()=>{
      const cur = await (async ()=>{ const snap=await getDoc(doc(db,`rounds/${ROUND_ID}/participants`,currentUser));
        const d = snap.data(); const dl=typeof d.dailyLog==='string'?JSON.parse(d.dailyLog):d.dailyLog||{};
        return (dl[dateSelect.value]?.pushup)||0; })();
      const v = await showRepsModal('伏地挺身', cur); if (v===null) return;
      await saveReps('pushup', dateSelect.value, v);
    });
    btnRowing.addEventListener('click', async ()=>{
      const cur = await (async ()=>{ const snap=await getDoc(doc(db,`rounds/${ROUND_ID}/participants`,currentUser));
        const d = snap.data(); const dl=typeof d.dailyLog==='string'?JSON.parse(d.dailyLog):d.dailyLog||{};
        return (dl[dateSelect.value]?.rowing)||0; })();
      const v = await showRepsModal('划船', cur); if (v===null) return;
      await saveReps('rowing', dateSelect.value, v);
    });

    nameModalConfirm.addEventListener('click', async ()=>{
      const v = nameInput.value.trim();
      if (!v) return;
      try{ await saveOwnName(v); }catch(e){ alert(`更新名稱失敗：${e.code||e.message}`); }
      nameModal.style.display='none';
    });
    nameModalCancel.addEventListener('click', ()=> nameModal.style.display='none');

    dateSelect.addEventListener('change', ()=>{/* 數值會在 snapshot 後刷新 */});

    // ===== 自動登入（綁定 round）=====
    (async function boot(){
      // 若 localStorage 的 round 跟目前 ROUND_ID 不同，要求使用者重新登入（避免跨輪沿用舊身份誤寫到錯輪）
      const savedU = localStorage.getItem('currentUser');
      const savedR = localStorage.getItem('currentRoundId');
      initDate();
      if (savedU && savedR === ROUND_ID){
        currentUser = savedU;
        showApp();
      } else {
        showLogin();
      }
    })();
  </script>
</body>
</html>
