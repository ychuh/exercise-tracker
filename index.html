<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firestore 即時運動追蹤器</title>
    <!-- 使用 Tailwind CSS 進行快速美觀的排版 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        /* 自定義樣式 */
        .daily-log-table-container {
            overflow-x: auto;
        }
        .daily-log-table th, .daily-log-table td {
            min-width: 80px;
            text-align: center;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            margin: auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="p-6 md:p-12 min-h-screen flex items-center justify-center">

    <div class="bg-white p-8 rounded-2xl shadow-xl max-w-5xl w-full">
        <div class="flex flex-col md:flex-row justify-between items-center mb-4">
            <h1 class="text-3xl font-bold mb-2 text-center text-blue-800">30天運動挑戰追蹤 (即時同步)</h1>
            <p id="current-date" class="text-gray-600 text-sm md:text-base"></p>
        </div>
        <p class="text-gray-600 text-center mb-6">目標：30天內完成總計 2500 下運動</p>
        <div class="text-center text-sm text-gray-400 mb-4">
            <p>您的使用者 ID (用來共享)：</p>
            <p id="user-id" class="text-xs text-gray-500 font-mono break-all"></p>
        </div>

        <!-- 日期與參賽者選擇區 -->
        <div class="flex flex-col md:flex-row items-center justify-center gap-4 mb-8">
            <div class="flex items-center gap-2">
                <label for="date-select" class="text-lg font-medium text-gray-700">選擇日期:</label>
                <input type="date" id="date-select" class="p-2 rounded-lg border border-gray-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex items-center gap-2">
                <label for="participant-select" class="text-lg font-medium text-gray-700">選擇參賽者:</label>
                <select id="participant-select" class="p-2 rounded-lg border border-gray-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <!-- 選項將由 JavaScript 動態生成 -->
                </select>
            </div>
        </div>
        
        <!-- 運動輸入與參賽者管理按鈕 -->
        <div class="flex flex-wrap items-center justify-center gap-4 mb-8">
            <!-- 運動輸入按鈕 -->
            <button id="btn-squat" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition transform hover:scale-105">
                深蹲
            </button>
            <button id="btn-pushup" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition transform hover:scale-105">
                伏地挺身
            </button>
            <button id="btn-rowing" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition transform hover:scale-105">
                划船
            </button>
            <!-- 參賽者管理按鈕 -->
            <button id="btn-add-participant" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition transform hover:scale-105">
                新增參賽者
            </button>
        </div>

        <!-- 總進度表格 -->
        <div class="overflow-x-auto mb-8">
            <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                <thead>
                    <tr class="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal">
                        <th class="py-3 px-6 text-left">參賽者</th>
                        <th class="py-3 px-6 text-left">深蹲總計</th>
                        <th class="py-3 px-6 text-left">伏地挺身總計</th>
                        <th class="py-3 px-6 text-left">划船總計</th>
                        <th class="py-3 px-6 text-left">總計</th>
                        <th class="py-3 px-6 text-left">完成度</th>
                    </tr>
                </thead>
                <tbody id="progress-table-body" class="text-gray-600 text-sm font-light">
                    <!-- 表格資料將由 JavaScript 填充 -->
                </tbody>
            </table>
        </div>

        <!-- 每日紀錄表格 -->
        <h2 class="text-2xl font-bold mb-4 text-gray-800 text-center">每日運動紀錄 (8/16 - 9/15)</h2>
        <div class="daily-log-table-container">
            <table id="daily-log-table" class="bg-white border border-gray-200 rounded-lg shadow-sm w-full">
                <thead id="daily-log-table-head" class="bg-gray-100 text-gray-600 uppercase text-xs leading-normal">
                    <!-- 表頭將由 JavaScript 填充 -->
                </thead>
                <tbody id="daily-log-table-body" class="text-gray-600 text-sm font-light">
                    <!-- 表格資料將由 JavaScript 填充 -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- 自定義模態視窗用於輸入數量 -->
    <div id="reps-modal" class="modal">
        <div class="modal-content">
            <h3 id="reps-modal-title" class="text-xl font-bold mb-4">輸入數量</h3>
            <p id="reps-modal-text" class="mb-4 text-gray-700"></p>
            <input type="number" id="reps-input" class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4" placeholder="請輸入數量">
            <div class="flex justify-end gap-2">
                <button id="reps-modal-cancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">取消</button>
                <button id="reps-modal-confirm" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">確認</button>
            </div>
        </div>
    </div>

    <!-- 自定義模態視窗用於編輯名稱 -->
    <div id="name-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">編輯參賽者名稱</h3>
            <p id="name-modal-text" class="mb-4 text-gray-700"></p>
            <input type="text" id="name-input" class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4" placeholder="請輸入新名稱">
            <div class="flex justify-end gap-2">
                <button id="name-modal-cancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">取消</button>
                <button id="name-modal-confirm" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">確認</button>
            </div>
        </div>
    </div>

    <!-- Firebase 腳本 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // 從你的 Firebase 專案中貼上 firebaseConfig 物件
        const myFirebaseConfig = {
            apiKey: "AIzaSyBpgbhTJkxi5j8HrwpUzFfZHAABcOfZnKs",
            authDomain: "exercise-tracker-d339a.firebaseapp.com",
            projectId: "exercise-tracker-d339a",
            storageBucket: "exercise-tracker-d339a.firebasestorage.app",
            messagingSenderId: "133943402653",
            appId: "1:133943402653:web:03328186b7addd755b3474",
            measurementId: "G-VSP6K6KQHG"
        };
        
        // 全域變數，由 Canvas 環境提供
        const canvasConfig = {
          appId: typeof __app_id !== 'undefined' ? __app_id : myFirebaseConfig.projectId,
          firebaseConfig: typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : myFirebaseConfig,
          initialAuthToken: typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null,
        };

        // 確保程式碼在認證完成後才執行
        let userId = null;
        let unsubscribe = null;
        let db = null;
        let auth = null;
        let app = null;

        // 在本地儲存中使用的鍵名
        const STORAGE_KEY = 'exerciseChallengeDataV2';
        // 挑戰總目標
        const TOTAL_GOAL = 2500;
        
        // 獲取 DOM 元素
        const currentDateElem = document.getElementById('current-date');
        const dateSelect = document.getElementById('date-select');
        const participantSelect = document.getElementById('participant-select');
        const btnSquat = document.getElementById('btn-squat');
        const btnPushup = document.getElementById('btn-pushup');
        const btnRowing = document.getElementById('btn-rowing');
        const btnAddParticipant = document.getElementById('btn-add-participant');
        const progressTableBody = document.getElementById('progress-table-body');
        const dailyLogTableHead = document.getElementById('daily-log-table-head');
        const dailyLogTableBody = document.getElementById('daily-log-table-body');
        const userIdElem = document.getElementById('user-id');

        // 模態視窗元素
        const repsModal = document.getElementById('reps-modal');
        const repsModalTitle = document.getElementById('reps-modal-title');
        const repsModalText = document.getElementById('reps-modal-text');
        const repsInput = document.getElementById('reps-input');
        const repsModalConfirm = document.getElementById('reps-modal-confirm');
        const repsModalCancel = document.getElementById('reps-modal-cancel');
        
        const nameModal = document.getElementById('name-modal');
        const nameModalText = document.getElementById('name-modal-text');
        const nameInput = document.getElementById('name-input');
        const nameModalConfirm = document.getElementById('name-modal-confirm');
        const nameModalCancel = document.getElementById('name-modal-cancel');

        // 儲存參賽者進度的資料物件
        let challengeData = {};
        
        // 函數：格式化日期為 YYYY-MM-DD
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // 函數：生成日期範圍 (8/16 - 9/15)
        function generateDateRange() {
            const dates = [];
            let currentDate = new Date('2025-08-16');
            const endDate = new Date('2025-09-15');
            
            while (currentDate <= endDate) {
                dates.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return dates;
        }

        // 函數：從 Firestore 載入資料並即時監聽
        function loadDataFromFirestore() {
            if (unsubscribe) {
                unsubscribe(); // 停止舊的監聽器
            }
            // 建立 Firestore 查詢
            const usersRef = collection(db, `artifacts/${canvasConfig.appId}/public/data/participants`);
            const q = query(usersRef);

            // 設定 onSnapshot 監聽器以取得即時更新
            unsubscribe = onSnapshot(q, (querySnapshot) => {
                const fetchedData = {};
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // 將 dailyLog 欄位從 JSON 字串轉換為物件
                    if (data.dailyLog && typeof data.dailyLog === 'string') {
                        try {
                            data.dailyLog = JSON.parse(data.dailyLog);
                        } catch (e) {
                            console.error("解析 dailyLog JSON 失敗:", e);
                            data.dailyLog = {};
                        }
                    }
                    fetchedData[doc.id] = data;
                });
                challengeData = fetchedData;
                renderProgressTable();
                renderDailyLogTable();
                updateExerciseButtons(); // 新增：在資料更新時更新按鈕顯示
            }, (error) => {
                console.error("即時監聽資料失敗: ", error);
            });
        }
        
        // 函數：將資料儲存到 Firestore
        async function saveDataToFirestore(participantId) {
            try {
                const participantRef = doc(db, `artifacts/${canvasConfig.appId}/public/data/participants`, participantId);
                const dataToSave = { ...challengeData[participantId] };
                // 在儲存前，將 dailyLog 物件轉換為 JSON 字串
                dataToSave.dailyLog = JSON.stringify(dataToSave.dailyLog);
                await setDoc(participantRef, dataToSave, { merge: true });
                console.log(`參賽者 ${participantId} 的資料已成功同步到 Firestore！`);
            } catch (e) {
                console.error("同步資料到 Firestore 失敗: ", e);
            }
        }
        
        // 函數：新增參賽者
        async function addParticipant() {
            const newName = await showNameModal(null, "新增參賽者名稱:");
            if (newName) {
                const newParticipantId = 'participant_' + Date.now();
                const newParticipant = {
                    name: newName,
                    total: 0,
                    squat: 0,
                    pushup: 0,
                    rowing: 0,
                    dailyLog: {},
                    creatorId: userId
                };
                
                // 將新參賽者資料儲存到 Firestore
                try {
                    const newParticipantRef = doc(db, `artifacts/${canvasConfig.appId}/public/data/participants`, newParticipantId);
                    const dataToSave = { ...newParticipant };
                    dataToSave.dailyLog = JSON.stringify(dataToSave.dailyLog);
                    await setDoc(newParticipantRef, dataToSave);
                    console.log(`已成功新增參賽者：${newName}`);
                } catch (e) {
                    console.error("新增參賽者失敗: ", e);
                }
            }
        }

        // 函數：移除參賽者
        async function removeParticipant(participantId) {
            // 確認使用者 ID 與創建者 ID 相符
            const participant = challengeData[participantId];
            if (participant && participant.creatorId === userId) {
                try {
                    const participantRef = doc(db, `artifacts/${canvasConfig.appId}/public/data/participants`, participantId);
                    await deleteDoc(participantRef);
                    console.log(`已成功移除參賽者：${participant.name}`);
                } catch (e) {
                    console.error("移除參賽者失敗: ", e);
                }
            } else {
                console.warn("您沒有權限移除此參賽者！");
            }
        }
        
        // 函數：更新總進度表格顯示
        function renderProgressTable() {
            progressTableBody.innerHTML = '';
            // 更新下拉選單的選項
            participantSelect.innerHTML = '';
            const participantIds = Object.keys(challengeData).sort();
            participantIds.forEach(id => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = challengeData[id].name;
                participantSelect.appendChild(option);
            });
            
            // 如果沒有參賽者，新增預設選項
            if (participantIds.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '請先新增參賽者';
                participantSelect.appendChild(option);
            }
            
            Object.keys(challengeData).forEach(participantId => {
                const participant = challengeData[participantId];
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-100';

                const completionPercentage = ((participant.total / TOTAL_GOAL) * 100).toFixed(1);

                // 根據 creatorId 顯示/隱藏移除按鈕
                const deleteButton = participant.creatorId === userId ?
                    `<button onclick="removeParticipant('${participantId}')" class="text-red-500 hover:text-red-700 ml-2">[移除]</button>` : '';

                row.innerHTML = `
                    <td class="py-3 px-6 text-left whitespace-nowrap">
                        ${participant.name}
                        <button onclick="editParticipantName('${participantId}')" class="text-blue-500 hover:text-blue-700 ml-2">[編輯]</button>
                        ${deleteButton}
                    </td>
                    <td class="py-3 px-6 text-left">${participant.squat}</td>
                    <td class="py-3 px-6 text-left">${participant.pushup}</td>
                    <td class="py-3 px-6 text-left">${participant.rowing}</td>
                    <td class="py-3 px-6 text-left font-bold text-lg">${participant.total}</td>
                    <td class="py-3 px-6 text-left">
                        <div class="bg-gray-200 rounded-full h-2.5">
                            <div class="bg-blue-500 h-2.5 rounded-full" style="width: ${Math.min(completionPercentage, 100)}%;"></div>
                        </div>
                        <span class="text-xs text-gray-500">${completionPercentage}%</span>
                    </td>
                `;
                progressTableBody.appendChild(row);
            });

            // 如果沒有參賽者，顯示提示訊息
            if (Object.keys(challengeData).length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `<td colspan="6" class="py-4 text-center text-gray-500">
                    目前沒有參賽者。請點擊「新增參賽者」按鈕來開始吧！
                </td>`;
                progressTableBody.appendChild(emptyRow);
            }
        }

        // 函數：更新每日紀錄表格顯示
        function renderDailyLogTable() {
            dailyLogTableHead.innerHTML = '';
            dailyLogTableBody.innerHTML = '';

            const dates = generateDateRange();

            // 創建表頭
            let headerRow = document.createElement('tr');
            headerRow.className = 'daily-log-table';
            let nameHeader = document.createElement('th');
            nameHeader.className = 'py-3 px-6 text-left';
            nameHeader.textContent = '參賽者';
            headerRow.appendChild(nameHeader);
            dates.forEach(date => {
                const dateHeader = document.createElement('th');
                dateHeader.className = 'py-3 px-2 text-center text-xs';
                dateHeader.textContent = `${date.getMonth() + 1}/${date.getDate()}`;
                headerRow.appendChild(dateHeader);
            });
            dailyLogTableHead.appendChild(headerRow);

            // 創建表格內容
            Object.values(challengeData).forEach(participant => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-100';
                
                let nameCell = document.createElement('td');
                nameCell.className = 'py-3 px-6 text-left whitespace-nowrap';
                nameCell.textContent = participant.name;
                row.appendChild(nameCell);

                dates.forEach(date => {
                    const dateStr = formatDate(date);
                    const dailyData = participant.dailyLog[dateStr] || { squat: 0, pushup: 0, rowing: 0 };
                    const dailyTotal = dailyData.squat + dailyData.pushup + dailyData.rowing;
                    
                    const cell = document.createElement('td');
                    cell.className = 'py-3 px-2 text-center text-xs';
                    cell.textContent = dailyTotal > 0 ? dailyTotal : '-';
                    row.appendChild(cell);
                });
                dailyLogTableBody.appendChild(row);
            });

            // 如果沒有參賽者，顯示提示訊息
            if (Object.keys(challengeData).length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `<td colspan="${dates.length + 1}" class="py-4 text-center text-gray-500">
                    目前沒有參賽者。請新增一位來開始追蹤吧！
                </td>`;
                dailyLogTableBody.appendChild(emptyRow);
            }
        }

        // 函數：更新運動按鈕的次數顯示
        function updateExerciseButtons() {
            const participantId = participantSelect.value;
            const selectedDate = dateSelect.value;
            if (!participantId || !selectedDate) {
                btnSquat.textContent = `深蹲`;
                btnPushup.textContent = `伏地挺身`;
                btnRowing.textContent = `划船`;
                return;
            }

            const participantData = challengeData[participantId];
            if (!participantData) return;

            const dailyData = participantData.dailyLog[selectedDate] || { squat: 0, pushup: 0, rowing: 0 };
            
            btnSquat.textContent = `深蹲 (${dailyData.squat})`;
            btnPushup.textContent = `伏地挺身 (${dailyData.pushup})`;
            btnRowing.textContent = `划船 (${dailyData.rowing})`;
        }

        // 函數：顯示數量輸入模態視窗
        function showRepsModal(exerciseType, initialValue) {
            return new Promise((resolve, reject) => {
                repsModal.style.display = 'flex';
                repsModalTitle.textContent = `編輯${exerciseType}數量`;
                const participantName = challengeData[participantSelect.value]?.name || '參賽者';
                const selectedDate = dateSelect.value;
                repsModalText.textContent = `請輸入 ${participantName} 在 ${selectedDate} 完成的 ${exerciseType} 數量：`;
                repsInput.value = initialValue !== undefined ? initialValue : '';
                repsInput.focus();

                const onConfirm = () => {
                    repsModal.style.display = 'none';
                    const reps = parseInt(repsInput.value, 10);
                    if (isNaN(reps) || reps < 0) {
                        console.error("輸入無效！請輸入一個正整數。");
                        resolve(null); // Return null for invalid input
                    } else {
                        resolve(reps);
                    }
                    repsModalConfirm.removeEventListener('click', onConfirm);
                    repsModalCancel.removeEventListener('click', onCancel);
                };

                const onCancel = () => {
                    repsModal.style.display = 'none';
                    resolve(null); // Return null on cancel
                    repsModalConfirm.removeEventListener('click', onConfirm);
                    repsModalCancel.removeEventListener('click', onCancel);
                };

                repsModalConfirm.addEventListener('click', onConfirm);
                repsModalCancel.addEventListener('click', onCancel);
            });
        }
        
        // 函數：處理按鈕點擊事件
        async function handleExerciseClick(exerciseType) {
            const participantId = participantSelect.value;
            if (!participantId || !challengeData[participantId]) {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <h3 class="text-xl font-bold mb-4">提示</h3>
                        <p class="mb-4 text-gray-700">請先新增一位參賽者！</p>
                        <div class="flex justify-end">
                            <button id="modal-ok" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">確認</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.style.display = 'flex';
                document.getElementById('modal-ok').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                return;
            }
            const selectedDate = dateSelect.value;
            
            // 獲取當前次數
            const dailyData = challengeData[participantId]?.dailyLog[selectedDate] || { squat: 0, pushup: 0, rowing: 0 };
            const currentReps = dailyData[exerciseType] || 0;

            const newReps = await showRepsModal(exerciseType, currentReps);

            if (newReps !== null) {
                const oldReps = challengeData[participantId]?.dailyLog[selectedDate]?.[exerciseType] || 0;
                const diff = newReps - oldReps;

                // 確保每日紀錄物件存在
                if (!challengeData[participantId].dailyLog) {
                    challengeData[participantId].dailyLog = {};
                }
                if (!challengeData[participantId].dailyLog[selectedDate]) {
                    challengeData[participantId].dailyLog[selectedDate] = { squat: 0, pushup: 0, rowing: 0 };
                }

                // 更新每日資料和總計
                challengeData[participantId].dailyLog[selectedDate][exerciseType] = newReps;
                challengeData[participantId][exerciseType] += diff;
                challengeData[participantId].total += diff;

                // 儲存並重新渲染
                await saveDataToFirestore(participantId);
            }
        }

        // 函數：顯示名稱編輯模態視窗
        function showNameModal(participantId, titleText) {
            return new Promise((resolve, reject) => {
                nameModal.style.display = 'flex';
                document.querySelector('#name-modal h3').textContent = titleText || '編輯參賽者名稱';
                const currentName = participantId ? challengeData[participantId].name : '';
                nameInput.value = currentName;
                nameInput.focus();

                const onConfirm = () => {
                    nameModal.style.display = 'none';
                    const newName = nameInput.value.trim();
                    if (newName !== "") {
                        resolve(newName);
                    } else {
                        resolve(null);
                    }
                    nameModalConfirm.removeEventListener('click', onConfirm);
                    nameModalCancel.removeEventListener('click', onCancel);
                };

                const onCancel = () => {
                    nameModal.style.display = 'none';
                    resolve(null); // Return null on cancel
                    nameModalConfirm.removeEventListener('click', onConfirm);
                    nameModalCancel.removeEventListener('click', onCancel);
                };

                nameModalConfirm.addEventListener('click', onConfirm);
                nameModalCancel.addEventListener('click', onCancel);
            });
        }

        // 函數：編輯參賽者名稱
        async function editParticipantName(participantId) {
            const newName = await showNameModal(participantId);
            
            if (newName !== null) {
                challengeData[participantId].name = newName;
                await saveDataToFirestore(participantId);
            }
        }
        
        // 將編輯和移除函數暴露給全局，以便 HTML 中的 `onclick` 使用
        window.editParticipantName = editParticipantName;
        window.removeParticipant = removeParticipant;
        window.addParticipant = addParticipant;

        // 綁定事件監聽器
        btnSquat.addEventListener('click', () => handleExerciseClick('squat'));
        btnPushup.addEventListener('click', () => handleExerciseClick('pushup'));
        btnRowing.addEventListener('click', () => handleExerciseClick('rowing'));
        btnAddParticipant.addEventListener('click', addParticipant);
        
        // 當日期或參賽者變更時，更新運動按鈕顯示
        dateSelect.addEventListener('change', updateExerciseButtons);
        participantSelect.addEventListener('change', updateExerciseButtons);

        // 頁面載入時執行
        async function startApp() {
            // 顯示當前日期並設定日期選擇器
            const today = new Date();
            const todayStr = formatDate(today);
            currentDateElem.textContent = today.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
            dateSelect.value = todayStr;

            // 進行 Firebase 認證
            try {
                // 初始化 Firebase 應用程式
                app = initializeApp(canvasConfig.firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                const analytics = getAnalytics(app);

                if (canvasConfig.initialAuthToken) {
                    const userCredential = await signInWithCustomToken(auth, canvasConfig.initialAuthToken);
                    userId = userCredential.user.uid;
                } else {
                    const userCredential = await signInAnonymously(auth);
                    userId = userCredential.user.uid;
                }
                userIdElem.textContent = userId;
                
                // 載入資料並即時監聽
                loadDataFromFirestore();
            } catch (error) {
                console.error("Firebase 認證失敗:", error);
                userIdElem.textContent = "認證失敗";
            }
        }

        window.onload = startApp;

    </script>

</body>
</html>
