<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>30天運動挑戰追蹤器</title>
    <!-- 使用 Tailwind CSS 進行快速美觀的排版 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        /* Custom styles for daily log table */
        .daily-log-table-container {
            overflow-x: auto;
        }
        .daily-log-table th, .daily-log-table td {
            min-width: 80px;
            text-align: center;
        }
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            margin: auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="p-6 md:p-12 min-h-screen flex items-center justify-center">

    <div class="bg-white p-8 rounded-2xl shadow-xl max-w-5xl w-full">
        <div class="flex flex-col md:flex-row justify-between items-center mb-4">
            <h1 class="text-3xl font-bold mb-2 text-center text-blue-800">30天運動挑戰追蹤</h1>
            <p id="current-date" class="text-gray-600 text-sm md:text-base"></p>
        </div>
        <p class="text-gray-600 text-center mb-6">目標：30天內完成總計 2500 下運動</p>

        <!-- 參賽者選擇與數據輸入區 -->
        <div class="flex flex-col md:flex-row items-center justify-center gap-4 mb-8">
            <div class="flex items-center gap-2">
                <label for="participant-select" class="text-lg font-medium text-gray-700">選擇參賽者:</label>
                <select id="participant-select" class="p-2 rounded-lg border border-gray-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="user1">參賽者 A</option>
                    <option value="user2">參賽者 B</option>
                    <option value="user3">參賽者 C</option>
                    <option value="user4">參賽者 D</option>
                </select>
            </div>
            
            <div class="flex gap-4">
                <!-- 運動輸入按鈕 -->
                <button id="btn-squat" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition transform hover:scale-105">
                    深蹲
                </button>
                <button id="btn-pushup" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition transform hover:scale-105">
                    伏地挺身
                </button>
                <button id="btn-rowing" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition transform hover:scale-105">
                    划船
                </button>
            </div>
        </div>

        <!-- 總進度表格 -->
        <div class="overflow-x-auto mb-8">
            <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                <thead>
                    <tr class="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal">
                        <th class="py-3 px-6 text-left">參賽者</th>
                        <th class="py-3 px-6 text-left">深蹲總計</th>
                        <th class="py-3 px-6 text-left">伏地挺身總計</th>
                        <th class="py-3 px-6 text-left">划船總計</th>
                        <th class="py-3 px-6 text-left">總計</th>
                        <th class="py-3 px-6 text-left">完成度</th>
                    </tr>
                </thead>
                <tbody id="progress-table-body" class="text-gray-600 text-sm font-light">
                    <!-- 表格資料將由 JavaScript 填充 -->
                </tbody>
            </table>
        </div>

        <!-- 每日紀錄表格 -->
        <h2 class="text-2xl font-bold mb-4 text-gray-800 text-center">每日運動紀錄 (8/16 - 9/15)</h2>
        <div class="daily-log-table-container">
            <table id="daily-log-table" class="bg-white border border-gray-200 rounded-lg shadow-sm w-full">
                <thead id="daily-log-table-head" class="bg-gray-100 text-gray-600 uppercase text-xs leading-normal">
                    <!-- 表頭將由 JavaScript 填充 -->
                </thead>
                <tbody id="daily-log-table-body" class="text-gray-600 text-sm font-light">
                    <!-- 表格資料將由 JavaScript 填充 -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- 自定義模態視窗用於輸入數量 -->
    <div id="reps-modal" class="modal">
        <div class="modal-content">
            <h3 id="reps-modal-title" class="text-xl font-bold mb-4">輸入數量</h3>
            <p id="reps-modal-text" class="mb-4 text-gray-700"></p>
            <input type="number" id="reps-input" class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4" placeholder="請輸入數量">
            <div class="flex justify-end gap-2">
                <button id="reps-modal-cancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">取消</button>
                <button id="reps-modal-confirm" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">確認</button>
            </div>
        </div>
    </div>

    <!-- 自定義模態視窗用於編輯名稱 -->
    <div id="name-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">編輯參賽者名稱</h3>
            <p id="name-modal-text" class="mb-4 text-gray-700"></p>
            <input type="text" id="name-input" class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4" placeholder="請輸入新名稱">
            <div class="flex justify-end gap-2">
                <button id="name-modal-cancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">取消</button>
                <button id="name-modal-confirm" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">確認</button>
            </div>
        </div>
    </div>

    <script>
        // 在本地儲存中使用的鍵名
        const STORAGE_KEY = 'exerciseChallengeDataV2';
        // 挑戰總目標
        const TOTAL_GOAL = 2500;
        
        // 預設參賽者資料結構
        const initialData = {
            'user1': { name: '參賽者 A', total: 0, squat: 0, pushup: 0, rowing: 0, dailyLog: {} },
            'user2': { name: '參賽者 B', total: 0, squat: 0, pushup: 0, rowing: 0, dailyLog: {} },
            'user3': { name: '參賽者 C', total: 0, squat: 0, pushup: 0, rowing: 0, dailyLog: {} },
            'user4': { name: '參賽者 D', total: 0, squat: 0, pushup: 0, rowing: 0, dailyLog: {} },
        };

        // 獲取 DOM 元素
        const currentDateElem = document.getElementById('current-date');
        const participantSelect = document.getElementById('participant-select');
        const btnSquat = document.getElementById('btn-squat');
        const btnPushup = document.getElementById('btn-pushup');
        const btnRowing = document.getElementById('btn-rowing');
        const progressTableBody = document.getElementById('progress-table-body');
        const dailyLogTableHead = document.getElementById('daily-log-table-head');
        const dailyLogTableBody = document.getElementById('daily-log-table-body');

        // 模態視窗元素
        const repsModal = document.getElementById('reps-modal');
        const repsModalTitle = document.getElementById('reps-modal-title');
        const repsModalText = document.getElementById('reps-modal-text');
        const repsInput = document.getElementById('reps-input');
        const repsModalConfirm = document.getElementById('reps-modal-confirm');
        const repsModalCancel = document.getElementById('reps-modal-cancel');
        
        const nameModal = document.getElementById('name-modal');
        const nameModalText = document.getElementById('name-modal-text');
        const nameInput = document.getElementById('name-input');
        const nameModalConfirm = document.getElementById('name-modal-confirm');
        const nameModalCancel = document.getElementById('name-modal-cancel');


        // 儲存參賽者進度的資料物件
        let challengeData = {};

        // 函數：格式化日期為 YYYY-MM-DD
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // 函數：生成日期範圍 (8/16 - 9/15)
        function generateDateRange() {
            const dates = [];
            let currentDate = new Date('2025-08-16');
            const endDate = new Date('2025-09-15');
            
            while (currentDate <= endDate) {
                dates.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return dates;
        }

        // 函數：從 localStorage 載入資料
        function loadData() {
            try {
                const storedData = localStorage.getItem(STORAGE_KEY);
                if (storedData) {
                    challengeData = JSON.parse(storedData);
                    // 確保載入的資料包含所有預設參賽者
                    Object.keys(initialData).forEach(key => {
                        if (!challengeData[key]) {
                            challengeData[key] = initialData[key];
                        }
                    });
                } else {
                    challengeData = initialData;
                }
            } catch (e) {
                console.error("無法從 localStorage 載入資料", e);
                challengeData = initialData;
            }
        }

        // 函數：將資料儲存到 localStorage
        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(challengeData));
            } catch (e) {
                console.error("無法將資料儲存到 localStorage", e);
            }
        }

        // 函數：更新總進度表格顯示
        function renderProgressTable() {
            progressTableBody.innerHTML = '';
            // 更新下拉選單的選項
            participantSelect.innerHTML = '';
            Object.keys(challengeData).forEach(id => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = challengeData[id].name;
                participantSelect.appendChild(option);
            });
            
            Object.values(challengeData).forEach(participant => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-100';

                const completionPercentage = ((participant.total / TOTAL_GOAL) * 100).toFixed(1);
                const participantId = Object.keys(challengeData).find(key => challengeData[key] === participant);

                row.innerHTML = `
                    <td class="py-3 px-6 text-left whitespace-nowrap">
                        ${participant.name} <button onclick="editParticipantName('${participantId}')" class="text-blue-500 hover:text-blue-700 ml-2">[編輯]</button>
                    </td>
                    <td class="py-3 px-6 text-left">${participant.squat}</td>
                    <td class="py-3 px-6 text-left">${participant.pushup}</td>
                    <td class="py-3 px-6 text-left">${participant.rowing}</td>
                    <td class="py-3 px-6 text-left font-bold text-lg">${participant.total}</td>
                    <td class="py-3 px-6 text-left">
                        <div class="bg-gray-200 rounded-full h-2.5">
                            <div class="bg-blue-500 h-2.5 rounded-full" style="width: ${Math.min(completionPercentage, 100)}%;"></div>
                        </div>
                        <span class="text-xs text-gray-500">${completionPercentage}%</span>
                    </td>
                `;
                progressTableBody.appendChild(row);
            });
        }

        // 函數：更新每日紀錄表格顯示
        function renderDailyLogTable() {
            dailyLogTableHead.innerHTML = '';
            dailyLogTableBody.innerHTML = '';

            const dates = generateDateRange();

            // 創建表頭
            let headerRow = document.createElement('tr');
            headerRow.className = 'daily-log-table';
            let nameHeader = document.createElement('th');
            nameHeader.className = 'py-3 px-6 text-left';
            nameHeader.textContent = '參賽者';
            headerRow.appendChild(nameHeader);
            dates.forEach(date => {
                const dateHeader = document.createElement('th');
                dateHeader.className = 'py-3 px-2 text-center text-xs';
                dateHeader.textContent = `${date.getMonth() + 1}/${date.getDate()}`;
                headerRow.appendChild(dateHeader);
            });
            dailyLogTableHead.appendChild(headerRow);

            // 創建表格內容
            Object.values(challengeData).forEach(participant => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-100';
                
                let nameCell = document.createElement('td');
                nameCell.className = 'py-3 px-6 text-left whitespace-nowrap';
                nameCell.textContent = participant.name;
                row.appendChild(nameCell);

                dates.forEach(date => {
                    const dateStr = formatDate(date);
                    const dailyData = participant.dailyLog[dateStr] || { squat: 0, pushup: 0, rowing: 0 };
                    const dailyTotal = dailyData.squat + dailyData.pushup + dailyData.rowing;
                    
                    const cell = document.createElement('td');
                    cell.className = 'py-3 px-2 text-center text-xs';
                    cell.textContent = dailyTotal > 0 ? dailyTotal : '-';
                    row.appendChild(cell);
                });
                dailyLogTableBody.appendChild(row);
            });
        }

        // 函數：顯示數量輸入模態視窗
        function showRepsModal(exerciseType) {
            return new Promise((resolve, reject) => {
                repsModal.style.display = 'flex';
                repsModalTitle.textContent = `輸入${exerciseType}數量`;
                const participantName = challengeData[participantSelect.value].name;
                repsModalText.textContent = `請輸入 ${participantName} 今天完成的 ${exerciseType} 數量：`;
                repsInput.value = '';
                repsInput.focus();

                const onConfirm = () => {
                    repsModal.style.display = 'none';
                    const reps = parseInt(repsInput.value, 10);
                    if (isNaN(reps) || reps < 0) {
                        alert("輸入無效！請輸入一個正整數。");
                        resolve(null); // Return null for invalid input
                    } else {
                        resolve(reps);
                    }
                    repsModalConfirm.removeEventListener('click', onConfirm);
                    repsModalCancel.removeEventListener('click', onCancel);
                };

                const onCancel = () => {
                    repsModal.style.display = 'none';
                    resolve(null); // Return null on cancel
                    repsModalConfirm.removeEventListener('click', onConfirm);
                    repsModalCancel.removeEventListener('click', onCancel);
                };

                repsModalConfirm.addEventListener('click', onConfirm);
                repsModalCancel.addEventListener('click', onCancel);
            });
        }
        
        // 函數：處理按鈕點擊事件
        async function handleExerciseClick(exerciseType) {
            const reps = await showRepsModal(exerciseType);

            if (reps !== null) {
                const participantId = participantSelect.value;
                const today = formatDate(new Date());

                // 確保每日紀錄物件存在
                if (!challengeData[participantId].dailyLog[today]) {
                    challengeData[participantId].dailyLog[today] = { squat: 0, pushup: 0, rowing: 0 };
                }

                // 更新每日資料和總計
                challengeData[participantId].dailyLog[today][exerciseType] += reps;
                challengeData[participantId][exerciseType] += reps;
                challengeData[participantId].total += reps;

                // 儲存並重新渲染
                saveData();
                renderProgressTable();
                renderDailyLogTable();
            }
        }

        // 函數：顯示名稱編輯模態視窗
        function showNameModal(participantId) {
            return new Promise((resolve, reject) => {
                const currentName = challengeData[participantId].name;
                nameModal.style.display = 'flex';
                nameModalText.textContent = `請輸入新的參賽者名稱:`;
                nameInput.value = currentName;
                nameInput.focus();

                const onConfirm = () => {
                    nameModal.style.display = 'none';
                    const newName = nameInput.value.trim();
                    if (newName !== "") {
                        resolve(newName);
                    } else {
                        resolve(null);
                    }
                    nameModalConfirm.removeEventListener('click', onConfirm);
                    nameModalCancel.removeEventListener('click', onCancel);
                };

                const onCancel = () => {
                    nameModal.style.display = 'none';
                    resolve(null); // Return null on cancel
                    nameModalConfirm.removeEventListener('click', onConfirm);
                    nameModalCancel.removeEventListener('click', onCancel);
                };

                nameModalConfirm.addEventListener('click', onConfirm);
                nameModalCancel.addEventListener('click', onCancel);
            });
        }

        // 函數：編輯參賽者名稱
        async function editParticipantName(participantId) {
            const newName = await showNameModal(participantId);
            
            if (newName !== null) {
                challengeData[participantId].name = newName;
                saveData();
                renderProgressTable();
                renderDailyLogTable();
            }
        }

        // 將編輯函數暴露給全局，以便 HTML 中的 `onclick` 使用
        window.editParticipantName = editParticipantName;

        // 綁定事件監聽器
        btnSquat.addEventListener('click', () => handleExerciseClick('squat'));
        btnPushup.addEventListener('click', () => handleExerciseClick('pushup'));
        btnRowing.addEventListener('click', () => handleExerciseClick('rowing'));

        // 頁面載入時執行
        window.onload = function() {
            // 顯示當前日期
            const today = new Date();
            currentDateElem.textContent = today.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });

            loadData();
            renderProgressTable();
            renderDailyLogTable();
        };

    </script>

</body>
</html>
